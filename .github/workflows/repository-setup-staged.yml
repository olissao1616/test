name: Setup repository via dispatch

on:
  repository_dispatch:
    types: [repository_setup]
  workflow_dispatch:
    inputs:
      LicensePlate:
        description: "License plate"
        required: true

concurrency:
  group: repo-setup-${{ github.repository }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  preflight:
    name: Preflight
    if: ${{ github.repository != 'bcgov-c/ministry-gitops-jag-template' }}
    runs-on: ubuntu-latest
    outputs:
      licence_plate: ${{ steps.vars.outputs.licence_plate }}
      app_name: ${{ steps.vars.outputs.app_name }}
    steps:
      - name: Compute inputs
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          LP="${{ github.event.client_payload.LicensePlate || github.event.inputs.LicensePlate }}"
          if [ -z "${LP}" ]; then
            echo "✗ LicensePlate is required" >&2
            exit 1
          fi

          LP="$(echo "${LP}" | tr '[:upper:]' '[:lower:]')"

          # Basic sanity check; adjust pattern to your org rules.
          if ! echo "${LP}" | grep -Eq '^[a-z0-9-]{3,20}$'; then
            echo "✗ LicensePlate must match ^[a-z0-9-]{3,20}$" >&2
            exit 1
          fi

          echo "licence_plate=${LP}" >> "$GITHUB_OUTPUT"
          echo "app_name=${LP}-app" >> "$GITHUB_OUTPUT"

      - name: Do not run scaffolding on template repository
        shell: bash
        run: |
          set -euo pipefail
          curl --silent -X GET \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.baptiste-preview+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}" \
            | jq --exit-status '.is_template == false' >/dev/null

  generate:
    name: Generate (cookiecutter)
    needs: preflight
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Cookiecutter
        run: |
          pip install --disable-pip-version-check cookiecutter==2.6.0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.14.4"

      - name: Generate GitOps Repository
        shell: bash
        run: |
          set -euo pipefail
          rm -rf ./cookiecutter-temp
          cookiecutter \
            ./gitops-repo \
            --verbose \
            --no-input \
            app_name="${{ needs.preflight.outputs.app_name }}" \
            licence_plate="${{ needs.preflight.outputs.licence_plate }}" \
            description="GitOps repository for ${{ needs.preflight.outputs.licence_plate }}" \
            --output-dir ./cookiecutter-temp

      - name: Collect generated workflows (artifact)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf ./generated-workflows
          mkdir -p ./generated-workflows
          cp -R ./cookiecutter-temp/*/.github/workflows/. ./generated-workflows/ 2>/dev/null || true
          ls -la ./generated-workflows || true

      - name: Package generated repo (artifact)
        shell: bash
        run: |
          set -euo pipefail
          rm -f generated-repo.tgz
          GEN_DIR="$(ls -1d ./cookiecutter-temp/* | head -n 1)"
          if [ -z "${GEN_DIR}" ] || [ ! -d "${GEN_DIR}" ]; then
            echo "✗ No generated directory found under cookiecutter-temp" >&2
            exit 1
          fi
          tar -czf generated-repo.tgz -C "${GEN_DIR}" .

      - name: Upload generated workflows (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: cookiecutter-workflows
          path: generated-workflows
          if-no-files-found: warn
          retention-days: 7

      - name: Upload generated repo (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: cookiecutter-generated-repo
          path: generated-repo.tgz
          retention-days: 1

  stage:
    name: Stage (prepare files)
    needs: [preflight, generate]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository (for policies/workflows only)
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.14.4"

      - name: Download generated repo
        uses: actions/download-artifact@v4
        with:
          name: cookiecutter-generated-repo

      - name: Unpack and prepare staged tree
        shell: bash
        run: |
          set -euo pipefail
          rm -rf ./staged
          mkdir -p ./staged
          tar -xzf generated-repo.tgz -C ./staged

          # Never ship workflows automatically (token restriction + safety)
          rm -rf ./staged/.github/workflows || true
          mkdir -p ./staged/.github || true

          if [ -d ./staged/charts/gitops ]; then
            helm dependency update ./staged/charts/gitops
          fi

          if [ -f ./staged/README.md ]; then
            APP_NAME='${{ needs.preflight.outputs.app_name }}'
            LICENCE_PLATE='${{ needs.preflight.outputs.licence_plate }}'
            sed -i \
              -e 's/\$app/'"${APP_NAME}"'/g' \
              -e 's/\$namespace/'"${LICENCE_PLATE}"'/g' \
              -e 's/\$team/'"${LICENCE_PLATE}"'-team/g' \
              ./staged/README.md
          fi

      - name: Package staged tree (artifact)
        shell: bash
        run: |
          set -euo pipefail
          tar -czf staged-repo.tgz -C ./staged .

      - name: Upload staged tree (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: cookiecutter-staged-repo
          path: staged-repo.tgz
          retention-days: 1

  push:
    name: Commit & Push (main/test/develop)
    needs: [preflight, stage]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download staged tree
        uses: actions/download-artifact@v4
        with:
          name: cookiecutter-staged-repo

      - name: Apply staged tree into repo root
        shell: bash
        run: |
          set -euo pipefail

          # Unpack into a temporary directory (never committed to the repo)
          STAGE_DIR="$(mktemp -d)"
          trap 'rm -rf "${STAGE_DIR}"' EXIT
          tar -xzf staged-repo.tgz -C "${STAGE_DIR}"

          # Cleanup any legacy folder from previous workflow revisions
          rm -rf ./_staged || true

          # Remove everything except .git and .github (keep current workflow files)
          find ./ -maxdepth 1 \
            ! -name '.git' \
            ! -name '.github' \
            ! -name '.' \
            -exec rm -rf {} +

          rsync -r --exclude '.github/workflows/**' "${STAGE_DIR}/" ./

          # Safety: ensure workflows are unchanged before committing.
          git restore .github/workflows 2>/dev/null || true

      - name: Commit and push branches
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          git add -A
          git commit -m "Automated commit: Create Cookiecutter template" || echo "No changes to commit."

          git branch -M main
          git push origin main

          git checkout -B test main
          git push -u origin test

          git checkout -B develop main
          git push -u origin develop

  protect:
    name: Request branch protection (dispatch to template repo)
    needs: [preflight, push]
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch protection request to template repo
        uses: peter-evans/repository-dispatch@v3
        continue-on-error: true
        with:
          token: ${{ secrets.CI || secrets.BRANCH_PROTECTION_TOKEN || github.token }}
          repository: olissao1616/ministry-gitops-jag-template
          event-type: protect-branches
          client-payload: >-
            {"target_repo":"${{ github.repository }}","licence_plate":"${{ needs.preflight.outputs.licence_plate }}","branches":"main,test,develop","required_contexts":"policy-check"}
