name: Template CI (smoke)

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'gitops-repo/**'
      - 'application/**'
      - 'charts/**'
      - 'deploy/**'
      - 'rbac/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'gitops-repo/**'
      - 'application/**'
      - 'charts/**'
      - 'deploy/**'
      - 'rbac/**'
      - '.github/workflows/ci.yml'

permissions:
  contents: read
  packages: read

env:
  POLICY_SOURCE_ORG: olissao1616
  POLICY_SOURCE_REPO: ag-devops
  POLICY_SOURCE_REF: main

jobs:
  generate:
    name: Generate test GitOps repo
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Cookiecutter
        run: pip install cookiecutter==2.6.0

      - name: Generate test GitOps repo
        run: |
          rm -rf /tmp/cookiecutter-out
          cookiecutter ./gitops-repo --no-input \
            app_name=test-app \
            licence_plate=abc123 \
            github_org=bcgov-c \
            --output-dir /tmp/cookiecutter-out

      - name: Upload generated repo
        uses: actions/upload-artifact@v4
        with:
          name: generated-gitops-repo
          path: /tmp/cookiecutter-out/test-app-gitops
          retention-days: 1

  render:
    name: Render (${{ matrix.env }})
    needs: generate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Helm login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Download generated repo
        uses: actions/download-artifact@v4
        with:
          name: generated-gitops-repo
          path: generated

      - name: Render manifests
        run: |
          cd generated/charts/gitops
          helm dependency update
          helm template test-app . \
            --values ../../deploy/${{ matrix.env }}_values.yaml \
            --namespace abc123-${{ matrix.env }} \
            > /tmp/rendered-${{ matrix.env }}.yaml
          echo "âœ“ Rendered $(wc -l < /tmp/rendered-${{ matrix.env }}.yaml) lines"

      - name: Upload manifests
        uses: actions/upload-artifact@v4
        with:
          name: rendered-${{ matrix.env }}
          path: /tmp/rendered-${{ matrix.env }}.yaml
          retention-days: 7

  conftest:
    name: Conftest (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download policies (curl)
        run: |
          set -euo pipefail
          mkdir -p .policy-cache
          base="https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/${POLICY_SOURCE_REF}/cd/policies"
          curl -fsSL "$base/network-policies.rego" -o .policy-cache/network-policies.rego
          curl -fsSL "$base/avi-infrasetting-annotation.rego" -o .policy-cache/avi-infrasetting-annotation.rego
          curl -fsSL "$base/routes-edge-termination.rego" -o .policy-cache/routes-edge-termination.rego

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Install Conftest
        run: |
          wget -q https://github.com/open-policy-agent/conftest/releases/download/v0.49.1/conftest_0.49.1_Linux_x86_64.tar.gz
          tar xzf conftest_0.49.1_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Run Conftest
        run: |
          conftest test rendered-${{ matrix.env }}.yaml \
            --policy .policy-cache/ \
            --all-namespaces \
            --output table \
            --fail-on-warn

  kube-linter:
    name: kube-linter (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download policies (curl)
        run: |
          set -euo pipefail
          mkdir -p .policy-cache
          base="https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/${POLICY_SOURCE_REF}/cd/policies"
          curl -fsSL "$base/kube-linter.yaml" -o .policy-cache/kube-linter.yaml

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Install kube-linter
        run: |
          wget -q https://github.com/stackrox/kube-linter/releases/download/v0.6.8/kube-linter-linux.tar.gz
          tar -xzf kube-linter-linux.tar.gz
          sudo mv kube-linter /usr/local/bin/
          kube-linter version

      - name: Run kube-linter
        run: |
          kube-linter lint rendered-${{ matrix.env }}.yaml --config .policy-cache/kube-linter.yaml

  polaris:
    name: Polaris (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download policies (curl)
        run: |
          set -euo pipefail
          mkdir -p .policy-cache
          base="https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/${POLICY_SOURCE_REF}/cd/policies"
          curl -fsSL "$base/polaris.yaml" -o .policy-cache/polaris.yaml

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Run Polaris
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            quay.io/fairwinds/polaris:10.1.4 \
            polaris audit \
            --audit-path /app/rendered-${{ matrix.env }}.yaml \
            --config /app/.policy-cache/polaris.yaml \
            --format pretty \
            --set-exit-code-below-score 100

  summary:
    name: Summary
    if: always()
    needs:
      - render
      - conftest
      - kube-linter
      - polaris
    runs-on: ubuntu-latest
    steps:
      - name: Write summary
        run: |
          echo "# Template CI (smoke)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cookiecutter -> Helm render (dev/test/prod) -> validators (Conftest, kube-linter, Polaris)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job results" >> $GITHUB_STEP_SUMMARY
          echo "- Render: ${{ needs.render.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Conftest: ${{ needs.conftest.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- kube-linter: ${{ needs.kube-linter.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Polaris: ${{ needs.polaris.result }}" >> $GITHUB_STEP_SUMMARY
