name: Protect branches (dispatch)

on:
  repository_dispatch:
    types: [protect-branches]

permissions:
    contents: write
    repository-projects: write

jobs:
  protect:
    name: Apply branch protections to target repo
    runs-on: ubuntu-latest
    steps:
      - name: Validate payload
        shell: bash
        env:
          TARGET_REPO: ${{ github.event.client_payload.target_repo }}
          BRANCHES: ${{ github.event.client_payload.branches }}
        run: |
          set -euo pipefail
          if [ -z "${TARGET_REPO}" ]; then
            echo "✗ Missing client_payload.target_repo (e.g., 'olissao1616/test')" >&2
            exit 1
          fi
          if [ -z "${BRANCHES}" ]; then
            echo "✗ Missing client_payload.branches (e.g., 'main,test,develop')" >&2
            exit 1
          fi

      - name: Apply branch protections
        uses: actions/github-script@v7
        with:
          # PAT (or GitHub App token) stored in repo A. This is what gives admin rights.
          github-token: ${{ secrets.CI }}
          script: |
            const payload = context?.payload?.client_payload || {};
            const targetRepo = String(payload.target_repo || '').trim();
            const licencePlate = String(payload.licence_plate || '').trim();
            const branchesCsv = String(payload.branches || '').trim();
            const contextsCsv = String(payload.required_contexts || 'policy-check').trim();

            if (!targetRepo.includes('/')) {
              core.setFailed(`Invalid client_payload.target_repo: ${targetRepo}`);
              return;
            }

            const [owner, repo] = targetRepo.split('/', 2);
            const branches = branchesCsv.split(',').map(s => s.trim()).filter(Boolean);
            const contexts = contextsCsv.split(',').map(s => s.trim()).filter(Boolean);

            if (branches.length === 0) {
              core.setFailed('No branches provided');
              return;
            }

            core.info(`Protecting repo: ${owner}/${repo}`);
            if (licencePlate) core.info(`Licence plate: ${licencePlate}`);
            core.info(`Branches: ${branches.join(', ')}`);
            core.info(`Required contexts: ${contexts.join(', ')}`);

            for (const branch of branches) {
              core.info(`Applying protection to ${branch}...`);
              await github.rest.repos.updateBranchProtection({
                owner,
                repo,
                branch,
                required_status_checks: {
                  strict: true,
                  contexts,
                },
                enforce_admins: true,
                required_pull_request_reviews: {
                  dismiss_stale_reviews: true,
                  require_code_owner_reviews: true,
                  required_approving_review_count: 2,
                },
                restrictions: null,
                required_linear_history: true,
                allow_force_pushes: false,
                allow_deletions: false,
                required_conversation_resolution: true,
              });
              core.info(`✓ Protected ${branch}`);
            }
