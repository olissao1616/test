{% raw %}name: Validate Policies (Comprehensive)

on:
  push:
    branches: [main, develop]
    paths: ['charts/**', 'deploy/**', '.github/workflows/**']
  pull_request:
    branches: [main, develop]
    paths: ['charts/**', 'deploy/**', '.github/workflows/**']

permissions:
  contents: read

env:
  POLICY_SOURCE_ORG: olissao1616
  POLICY_SOURCE_REPO: ag-devops
  POLICY_SOURCE_REF: main
  POLICY_DIR: .policy-cache

jobs:
  render:
    name: Render (${{ matrix.env }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Update Helm dependencies
        run: |
          cd charts/gitops
          helm dependency update

      - name: Render manifests
        run: |
          set -euo pipefail
          helm template gitops-app-${{ matrix.env }} ./charts/gitops \
            --values ./deploy/${{ matrix.env }}_values.yaml \
            --namespace ${{ matrix.env }} \
            > /tmp/rendered-${{ matrix.env }}.yaml
          echo "âœ“ Rendered $(wc -l < /tmp/rendered-${{ matrix.env }}.yaml) lines"

      - name: Upload rendered manifests
        uses: actions/upload-artifact@v4
        with:
          name: rendered-${{ matrix.env }}
          path: /tmp/rendered-${{ matrix.env }}.yaml
          retention-days: 7

  conftest:
    name: Conftest (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Install Conftest
        run: |
          wget -q https://github.com/open-policy-agent/conftest/releases/download/v0.49.1/conftest_0.49.1_Linux_x86_64.tar.gz
          tar xzf conftest_0.49.1_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Download policies (curl)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${POLICY_DIR}"
          base="https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/${POLICY_SOURCE_REF}/cd/policies"
          curl -fsSL "$base/network-policies.rego" -o "${POLICY_DIR}/network-policies.rego"
          curl -fsSL "$base/avi-infrasetting-annotation.rego" -o "${POLICY_DIR}/avi-infrasetting-annotation.rego"
          curl -fsSL "$base/routes-edge-termination.rego" -o "${POLICY_DIR}/routes-edge-termination.rego"

      - name: Run Conftest
        run: |
          conftest test rendered-${{ matrix.env }}.yaml \
            --policy "${POLICY_DIR}/" \
            --all-namespaces \
            --output table \
            --fail-on-warn

  datree:
    name: Datree (helm) (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Install Datree Helm plugin
        run: |
          helm plugin install https://github.com/datreeio/helm-datree
          helm plugin update datree
          helm datree config set offline local

      - name: Verify Datree plugin
        run: |
          set -euo pipefail
          helm plugin list
          helm datree --help

      - name: Download policies (curl)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${POLICY_DIR}"
          base="https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/${POLICY_SOURCE_REF}/cd/policies"
          curl -fsSL "$base/datree-policies.yaml" -o "${POLICY_DIR}/datree-policies.yaml"

      - name: Run Helm Datree policy enforcement
        run: |
          set -euo pipefail
          helm dependency update ./charts/gitops

          helm datree test --ignore-missing-schemas \
            --policy-config "${GITHUB_WORKSPACE}/${POLICY_DIR}/datree-policies.yaml" \
            --include-tests ./charts/gitops \
            -- --namespace "${{ matrix.env }}" --values "./deploy/${{ matrix.env }}_values.yaml" "gitops-app-${{ matrix.env }}"

  kubesec:
    name: Kubesec (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Run Kubesec scan
        run: |
          set -euo pipefail
          docker run --rm -v ${{ github.workspace }}:/work mikefarah/yq:4 \
            eval 'select(.kind == "Deployment" or .kind == "StatefulSet" or .kind == "DaemonSet" or .kind == "Job" or .kind == "CronJob" or .kind == "Pod")' \
            /work/rendered-${{ matrix.env }}.yaml > kubesec-input.yaml
          docker run -i kubesec/kubesec:v2 scan /dev/stdin < kubesec-input.yaml > kubesec-results-${{ matrix.env }}.json
          cat kubesec-results-${{ matrix.env }}.json

      - name: Upload Kubesec results
        uses: actions/upload-artifact@v4
        with:
          name: kubesec-${{ matrix.env }}
          path: kubesec-results-${{ matrix.env }}.json

  polaris:
    name: Polaris (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Download policies (curl)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${POLICY_DIR}"
          base="https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/${POLICY_SOURCE_REF}/cd/policies"
          curl -fsSL "$base/polaris.yaml" -o "${POLICY_DIR}/polaris.yaml"

      - name: Run Polaris audit
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            quay.io/fairwinds/polaris:10.1.4 \
            polaris audit \
            --audit-path /app/rendered-${{ matrix.env }}.yaml \
            --config /app/.policy-cache/polaris.yaml \
            --format pretty \
            --set-exit-code-below-score 100

      - name: Upload Polaris report
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            quay.io/fairwinds/polaris:10.1.4 \
            polaris audit \
            --audit-path /app/rendered-${{ matrix.env }}.yaml \
            --config /app/.policy-cache/polaris.yaml \
            --format json > polaris-report-${{ matrix.env }}.json

      - name: Upload Polaris report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: polaris-report-${{ matrix.env }}
          path: polaris-report-${{ matrix.env }}.json

  kube-score:
    name: kube-score (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Run kube-score
        run: |
          docker run --rm -v $(pwd):/project \
            zegl/kube-score:latest score \
            --output-format ci \
            --ignore-test container-security-context-user-group-id \
            /project/rendered-${{ matrix.env }}.yaml

  kube-linter:
    name: kube-linter (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Install kube-linter
        run: |
          wget -q https://github.com/stackrox/kube-linter/releases/download/v0.6.8/kube-linter-linux.tar.gz
          tar -xzf kube-linter-linux.tar.gz
          sudo mv kube-linter /usr/local/bin/
          kube-linter version

      - name: Download policies (curl)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${POLICY_DIR}"
          base="https://raw.githubusercontent.com/${POLICY_SOURCE_ORG}/${POLICY_SOURCE_REPO}/${POLICY_SOURCE_REF}/cd/policies"
          curl -fsSL "$base/kube-linter.yaml" -o "${POLICY_DIR}/kube-linter.yaml"

      - name: Run kube-linter
        run: |
          kube-linter lint rendered-${{ matrix.env }}.yaml --config "${POLICY_DIR}/kube-linter.yaml"

  pluto:
    name: Pluto (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Download Pluto
        uses: FairwindsOps/pluto/github-action@v5.22.7
        with:
          IMAGE_TAG: v5
          CONTAINER_ENGINE: docker

      - name: Run Pluto scan
        run: |
          set -euo pipefail
          pluto detect rendered-${{ matrix.env }}.yaml --target-versions k8s=v1.28.0

  trivy:
    name: Trivy (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'rendered-${{ matrix.env }}.yaml'
          format: 'sarif'
          output: 'trivy-results-${{ matrix.env }}.sarif'

      - name: Upload Trivy results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-${{ matrix.env }}
          path: trivy-results-${{ matrix.env }}.sarif

  checkov:
    name: Checkov (${{ matrix.env }})
    needs: render
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, test, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-${{ matrix.env }}

      - name: Run Checkov scan
        uses: bridgecrewio/checkov-action@master
        with:
          file: rendered-${{ matrix.env }}.yaml
          framework: kubernetes
          skip_check: CKV_K8S_43
          output_format: cli,sarif
          output_file_path: console,checkov-results-${{ matrix.env }}.sarif

      - name: Upload Checkov results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-${{ matrix.env }}
          path: checkov-results-${{ matrix.env }}.sarif

  summary:
    name: Validation summary
    if: always()
    needs:
      - render
      - conftest
      - datree
      - kubesec
      - polaris
      - kube-score
      - kube-linter
      - pluto
      - trivy
      - checkov
    runs-on: ubuntu-latest
    steps:
      - name: Write summary
        run: |
          echo "# Network policy validation (comprehensive)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Helm render (dev/test/prod) -> validators (Conftest, Datree, Kubesec, Polaris, kube-score, kube-linter, Pluto, Trivy, Checkov)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job results" >> $GITHUB_STEP_SUMMARY
          echo "- Render: ${{ needs.render.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Conftest: ${{ needs.conftest.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Datree (helm): ${{ needs.datree.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Kubesec: ${{ needs.kubesec.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Polaris: ${{ needs.polaris.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- kube-score: ${{ needs.kube-score.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- kube-linter: ${{ needs.kube-linter.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Pluto: ${{ needs.pluto.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy: ${{ needs.trivy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Checkov: ${{ needs.checkov.result }}" >> $GITHUB_STEP_SUMMARY
{% endraw %}

