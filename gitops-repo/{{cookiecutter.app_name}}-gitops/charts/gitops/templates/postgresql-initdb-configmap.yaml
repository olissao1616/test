{% raw %}
{{- $pg := (.Values.postgresql | default dict) -}}
{{- $pgEnabled := (index $pg "enabled" | default false) -}}
{{- $primary := (index $pg "primary" | default dict) -}}
{{- $initdb := (index $primary "initdb" | default dict) -}}
{{- $cmName := (index $initdb "scriptsConfigMap" | default "") -}}
{{- if and $pgEnabled $cmName -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $cmName | quote }}
  namespace: {{ .Release.Namespace | quote }}
  labels:
{{ include "gitops.labels" . | nindent 4 }}
data:
{{- $files := .Files.Glob "files/postgresql/init/*.sql" -}}
{{- if $files -}}
{{- range $path, $_ := $files }}
  {{ base $path }}: |-
{{ $.Files.Get $path | nindent 4 }}
{{- end -}}
{{- else -}}
  README.txt: |-
    No SQL files found under files/postgresql/init/*.sql
{{- end -}}
{{- end }}
{% endraw %}
